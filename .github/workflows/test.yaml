name: Test a docker deployment

on:
  workflow_run:
    workflows: ["Build a Docker Image"]
    types:
      - completed
  
jobs:
  test-discovery-server:
    runs-on: ubuntu-20.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Deploy Fast DDS Discovery Server
      continue-on-error: true
      timeout-minutes: 1
      run: |
        echo JOINCODE=${{ secrets.HUSARNET_JOINCODE }} > .env
        docker-compose -f docker-compose.discovery-server.yml up | tee output.txt

    - name: Check if the log contains Hello World string
      run: if [[ $(grep 'Hello World' output.txt | wc -l) -eq 0 ]]; then exit 1; fi

  test-listener:
    runs-on: ubuntu-20.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout
      uses: actions/checkout@v1
  
    - name: Deploy Listener
      continue-on-error: true
      timeout-minutes: 1
      run: |
        echo JOINCODE=${{ secrets.HUSARNET_JOINCODE }} > .env
        docker-compose -f docker-compose.listener.yml up | tee output.txt

    - name: Check if the log contains Hello World string
      run: if [[ $(grep 'Hello World' output.txt | wc -l) -eq 0 ]]; then exit 1; fi

  test-talker:
    runs-on: ubuntu-20.04
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - name: Deploy Talker
      continue-on-error: true
      timeout-minutes: 1
      run: |
        echo JOINCODE=${{ secrets.HUSARNET_JOINCODE }} > .env
        docker-compose -f docker-compose.talker.yml up | tee output.txt

    - name: Check if the log contains Hello World string
      run: if [[ $(grep 'Hello World' output.txt | wc -l) -eq 0 ]]; then exit 1; fi